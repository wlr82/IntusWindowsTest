@page "/orders"
@inject IOrderService OrderService
@inject IWindowService WindowService
@inject NavigationManager NavigationManager

<div class="container">
    <div class="row">
        <div class="col">
            <h4>Orders</h4>

            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>State</th>
                        <th style="min-width: 100px;">
                            <button class="btn btn-primary"
                                    @onclick="CreateOrder">
                                @* Create order *@
                                <i class="oi oi-plus"></i>
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in OrderService.Orders)
                    {
                        string colorClass = (order == SelectedOrder) ? "bg-info" : "";
                        <tr class="@colorClass" style="cursor:pointer" 
                            @onclick="async () => { SelectedOrder = order; await RefreshWindowsByOrderId(order.Id);}">
                            <td>@order.Name</td>
                            <td>@order.State.Code</td>
                            <td>
                                <button class="btn btn-primary"
                                        @onclick="(() => ShowOrder(order.Id))">
                                    <i class="oi oi-pencil"></i>
                                </button>
                                <button class="btn btn-danger"
                                        @onclick="(() => DeleteOrder(order.Id))">
                                    <i class="oi oi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

        </div>
        <div class="col">
            <h4>Windows</h4>

            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Quantity of windows</th>
                        <th>Total sub elements</th>
                        <th style="min-width: 100px;">
                            @if (SelectedOrder.Id > 0)
                            {
                                <button class="btn btn-primary"
                                        @onclick="(() => CreateWindow(SelectedOrder.Id))">
                                    @* Create window *@
                                    <i class="oi oi-plus"></i>
                                </button>
                            }
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var window in WindowService.Windows)
                    {
                        string colorClass = (window == SelectedWindow) ? "bg-info" : "";
                        <tr class="@colorClass" style="cursor:pointer" @onclick="() => { SelectedWindow = window; }">
                            <td>@window.Name</td>
                            <td>@window.QuantityOfWindows</td>
                            <td>000</td>
                            <td>
                                <button class="btn btn-primary"
                                        @onclick="(() => EditWindow(window.Order.Id, window.Id))">
                                    <i class="oi oi-pencil"></i>
                                </button>
                                <button class="btn btn-danger"
                                        @onclick="(() => DeleteWindow(window.Order.Id, window.Id))">
                                    <i class="oi oi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

        </div>
        <div class="col">
            <h4>Sub elements</h4>
        </div>
    </div>
</div>


@code {
    DAL.Entities.Order SelectedOrder = new DAL.Entities.Order();
    DAL.Entities.Window SelectedWindow = new DAL.Entities.Window();

    protected override async Task OnInitializedAsync()
    {
        await OrderService.GetOrders();
    }

    void ShowOrder(int id)
    {
        NavigationManager.NavigateTo($"order/{id}");
    }

    void CreateOrder()
    {
        NavigationManager.NavigateTo("/order");
    }

    async Task DeleteOrder(int id)
    {
        await OrderService.DeleteOrder(id);
    }

    async Task RefreshWindowsByOrderId (int orderId)
    {
        await WindowService.GetWindowsByOrderId(orderId);
    }

    void CreateWindow(int orderId)
    {
        NavigationManager.NavigateTo($"/order/{orderId}/window/");
    }

    void EditWindow(int orderId, int windowId)
    {
        NavigationManager.NavigateTo($"/order/{orderId}/window/{windowId}");
    }

    async Task DeleteWindow(int orderId, int windowId)
    {
        await WindowService.DeleteWindow(orderId, windowId);
    }
}
